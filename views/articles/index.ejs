<%- include('header.ejs') %>

    <div class="container blog-home">
        <div class="blog-home-header">
            <h1 class="mb-4">Blog Articles</h1>
            <p>Search
            <input type="text" id="search-box" onkeyup="sendData(this)"/></p>
            <section id="searchResults">
            </section>
            <button class="blog-home-btn"><a href="/articles/new" class="btn btn-sucess">New Article</a></button>
        </div>

        <% articles.forEach(article => {%>
            <div class="card mt-4">
                <div class="card-body blog-home-article">
                    <h4 class="card-title blog-home-article-title"><%= article.title %></h4>
                    <div class="card-subtitle text-muted mb-2 blog-home-article-date">
                        <%= article.createdAt.toLocaleDateString() %>
                    </div>
                    <div class="card-text mb-2 blog-home-article-description"><%= article.description %></div>
                    <div class="blog-home-article-btns">
                        <button class="article-read-btn"><a href="articles/<%= article.slug %>" class="btn btn-primary">Read More</a></button>
                        <form action="/articles/<%= article.id %>?_method=DELETE" method="POST" class="d-inline">
                            <button type="submit" class="btn btn-danger article-delete-btn">Delete</button>
                        </form>
                    </div>
                </div>
            </div>
        <%})%>
    </div>

    <script>
        function sendData(e) {
            const searchResults = document.getElementById('searchResults');
            let match = e.value.match(/\s*/);
            if(match[0] === e.value) {
                searchResults.innerHTML = '';
                return;
            }
            fetch('/getArticles', {
                method: 'POST',
                headers: {'Content-Type': "application/json"},
                body: JSON.stringify({payload: e.value})
            }).then(res => res.json()).then(data=>{
                let payload = data.payload;
                console.log(payload);
                searchResults.innerHTML = "";
                if(payload.length < 1){
                    searchResults.innerHTML = '<p>Sorry. Nothing matches your search</p>'
                    return;
                }
                payload.forEach((item, index) => {
                    if(index > 0) searchResults.innerHTML += `<p><a href=/articles/${item.slug}>${item.title}</a></p>`;
                });
                return;
            });
        }
    </script>
</body>
</html>